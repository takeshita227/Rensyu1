Option Explicit


Private Sub UserForm_Initialize()
    txtDate.Value = Format(Date, "yyyy/mm/dd")
    txtDate.Enabled = False
    txtStopTime.Value = Format(Now, "hh:mm")
    txtStartTime.Value = Format(Now, "hh:mm")
    txtDuration.Enabled = False
    
    ' 初期化時に設備名・対応を非表示
    comProcess1.Visible = False
    comProcess2.Visible = False
    Label9.Visible = False
    Label12.Visible = False

    ' 停止理由の初期化（必要なら）
    comReason.Clear
    comReason.AddItem "交換"
    comReason.AddItem "不具合"
    comReason.AddItem "切替・手直し"
    comReason.AddItem "計画休止"
    comReason.AddItem "その他"
       
End Sub

Private Sub txtStartTime_Change()
    Dim stopTime As Date
    Dim startTime As Date
    Dim duration As Variant

    On Error GoTo ErrorHandler

    ' 時刻を取得
    stopTime = TimeValue(txtStopTime.Text)
    startTime = TimeValue(txtStartTime.Text)

    ' 差を計算
    duration = startTime - stopTime

    ' 結果を表示（hh:mm形式）
    txtDuration.Text = Format(duration, "hh:mm")
    Exit Sub

ErrorHandler:
    txtDuration.Text = "入力エラー"
End Sub

Private Sub comReason_Change()
    ' 停止理由詳細のコンボボックス初期化
    comDetails.Clear
    comProcess1.Clear
    comProcess2.Clear

    ' 一旦非表示
    comProcess1.Visible = False
    comProcess2.Visible = False
    Label9.Visible = False
    Label12.Visible = False

    Select Case comReason.Value
    
                
        Case "交換"
            comDetails.AddItem "研削治具"
            comDetails.AddItem "組立治具"
            comDetails.AddItem "砥石"
            comDetails.AddItem "消耗部品"

    
        Case "不具合"
            comDetails.AddItem "調整"
            comDetails.AddItem "故障"

            ' 表示（工程大分類・対応）
            comProcess1.Visible = True
            comProcess2.Visible = True
            Label9.Visible = True
            Label12.Visible = True

            ' 工程大分類の選択肢
            comProcess1.AddItem "外R(研削)"
            comProcess1.AddItem "内R(研削)"
            comProcess1.AddItem "組立"
            comProcess1.AddItem "組立(検査)"

        Case "切替・手直し"
            comDetails.AddItem "呼番切替"
            comDetails.AddItem "シリーズ切替"
            comDetails.AddItem "手直し"
            
        Case "その他"
            comDetails.AddItem "干渉手待ち"
            comDetails.AddItem "材料手待ち"
            comDetails.AddItem "ミーティング"
            comDetails.AddItem "朝礼"
            comDetails.AddItem "4S"

        Case Else
            comDetails.AddItem "　ー　"
    End Select
End Sub

Private Sub comProcess1_Change()
    ' 大分類（外R / 内R / 組立）選択時に、小分類を切り替える
    comProcess2.Clear

    Select Case comProcess1.Value
        Case "外R(研削)"
            comProcess2.AddItem "投入"
            comProcess2.AddItem "軌道研削"
            comProcess2.AddItem "超仕上げ"
            comProcess2.AddItem "単体洗浄"
            comProcess2.AddItem "単洗後脱油"
        Case "内R(研削)"
            comProcess2.AddItem "投入"
            comProcess2.AddItem "軌道研削"
            comProcess2.AddItem "内径研削"
            comProcess2.AddItem "A/G"
            comProcess2.AddItem "超仕上げ"
            comProcess2.AddItem "単体洗浄"
            comProcess2.AddItem "単洗後脱油"
        Case "組立"
            comProcess2.AddItem "R/M"
            comProcess2.AddItem "玉入れ"
            comProcess2.AddItem "玉割り"
            comProcess2.AddItem "保持器入れ"
            comProcess2.AddItem "保持器カシメ"
            comProcess2.AddItem "保持器カシメ後脱磁"
            comProcess2.AddItem "完成品洗浄"
            comProcess2.AddItem "完洗後脱油"
            comProcess2.AddItem "レーザー印字"
            comProcess2.AddItem "防錆"
            comProcess2.AddItem "外観整列"
        Case "組立(検査)"
            comProcess2.AddItem "トルク"
            comProcess2.AddItem "保持器"
            comProcess2.AddItem "ボールなし・リベットなし・異型番(シール溝ありなし)"
            comProcess2.AddItem "音"
            comProcess2.AddItem "すきま"
            comProcess2.AddItem "自動外観"
        Case Else
            comProcess2.AddItem "該当なし"
    End Select

    ' 小分類表示
    comProcess2.Visible = True
End Sub

Private Sub btnSubmit_Click()
    Dim ws As Worksheet
    Dim NextRow As Long
    Dim msg As String
    Dim stopT As Date, startT As Date
    Dim frmLoading As Object

    msg = ""
    
    ' ====== 未入力チェック ======
    If Trim(Me.txtDate.Value) = "" Then msg = msg & "・作成日" & vbCrLf
    If Trim(Me.txtStopTime.Value) = "" Then msg = msg & "・停止時刻" & vbCrLf
    If Trim(Me.txtStartTime.Value) = "" Then msg = msg & "・再開時刻" & vbCrLf
    If Trim(Me.txtDuration.Value) = "" Then msg = msg & "・停止時間" & vbCrLf
    If Trim(Me.comReason.Value) = "" Then msg = msg & "・停止理由" & vbCrLf
    If Trim(Me.comDetails.Value) = "" Then msg = msg & "・停止理由詳細" & vbCrLf

    If msg <> "" Then
        MsgBox "以下の項目が未入力です：" & vbCrLf & msg, vbExclamation, "入力チェック"
        Exit Sub
    End If
    ' ===========================

    ' ====== 時間の前後チェック ======
    On Error Resume Next ' ← ここを一旦安全に変更！
    stopT = CDate(Me.txtStopTime.Value)
    startT = CDate(Me.txtStartTime.Value)
    If Err.Number <> 0 Then
        MsgBox "時刻の形式が正しくありません。" & vbCrLf & _
               "例：08:30 や 17:45 のように入力してください。", vbExclamation, "入力エラー"
        Exit Sub
    End If
    On Error GoTo 0 ' ← エラー処理を元に戻す

    If startT <= stopT Then
        MsgBox "再開時刻は停止時刻より後の時間を入力してください。", vbExclamation, "時間エラー"
        Exit Sub
    End If
    ' ==============================

    ' ====== 「送信中…」表示 ======
   Set frmLoading = New frmLoading   ' ← 新しくフォームを作る
   frmLoading.Show vbModeless        ' ← モードレスで表示
   DoEvents                        ' ← 画面描画を待つ

    ' ==============================

    ' ====== 書き込み処理 ======
    Set ws = Sheets("ライン停止内容")

    NextRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row + 1

    With ws
        .Cells(NextRow, 1).Value = txtDate.Value
        .Cells(NextRow, 3).Value = txtStopTime.Value
        .Cells(NextRow, 4).Value = txtStartTime.Value
        .Cells(NextRow, 5).Value = txtDuration.Value
        .Cells(NextRow, 6).Value = comReason.Value
        .Cells(NextRow, 7).Value = comDetails.Value
        .Cells(NextRow, 8).Value = comProcess1.Value
        .Cells(NextRow, 9).Value = comProcess2.Value
        .Cells(NextRow, 10).Value = Format(Now, "yyyy/mm/dd hh:mm:ss")
        .Cells(NextRow, 11).Value = Environ("ComputerName")
    End With

    Unload frmLoading
    MsgBox "送信完了！", vbInformation

    ThisWorkbook.Save
    Unload Me
End Sub

Private Sub com_OpenTenKey1_Click()
    frmTenKeyTemplate.TextBox1.Text = ""
    
    ' txtDefective を直接渡す
    Set frmTenKeyTemplate.TargetTextBox = Me.txtStopTime
    
    frmTenKeyTemplate.Show vbModal

    ' 値を戻す
    If frmTenKeyTemplate.EnteredValue <> "" Then
        Me.txtStopTime.Text = frmTenKeyTemplate.EnteredValue
    End If
End Sub

Private Sub com_OpenTenKey2_Click()
    frmTenKeyTemplate.TextBox1.Text = ""
    
    ' txtDefective を直接渡す
    Set frmTenKeyTemplate.TargetTextBox = Me.txtStartTime
    
    frmTenKeyTemplate.Show vbModal

    ' 値を戻す
    If frmTenKeyTemplate.EnteredValue <> "" Then
        Me.txtStartTime.Text = frmTenKeyTemplate.EnteredValue
    End If
End Sub

Private Sub UserForm_KeyDown(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    ' Enterキーを制御（QR用以外は無効）
    If KeyCode = vbKeyReturn Then
        If Not (ActiveControl Is txtID Or ActiveControl Is txtYOBIBAN) Then
            KeyCode = 0
        End If
    End If
End Sub

2026/1/12/1149変更
2026/1/12/1154変更
2026/1/12/1242
